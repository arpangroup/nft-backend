<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dynamic MLM Tree</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="controls">
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
    <button onclick="resetZoom()">Reset</button>
    <button onclick="addUsers()">Add Dummy USers</button>
    <div id="selectedUserLabel"
      style="position: fixed; bottom: 10px; left: 10px; background: #222; color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 14px;">
      Click a user to see info here.
    </div>
  </div>

  <div class="controls-highlight">
    <!--    <button onclick="highlightLevel(1)">‚ò∞ Level-A</button>-->
    <button data-level="1" onclick="highlightLevel(1)">Highlight Level-A</button>
    <button data-level="2" onclick="highlightLevel(2)">Highlight Level-B</button>
    <button data-level="3" onclick="highlightLevel(3)">Highlight Level-C</button>
    <button onclick="clearHighlights()">Clear Highlights</button>
    <button onclick="scheduleIncome()">Schedule Income</button>
  </div>

  <div class="sidebar-toggle">
    <button onclick="toggleSidebar('sidebar-sql')"> ‚ò∞ Execute</button>
    <button onclick="toggleSidebar('sidebar-info')">‚ÑπÔ∏è Show Info</button>
    <button onclick="toggleSidebar('sidebar-register')">üìù Register User</button>
    <button onclick="toggleSidebar('sidebar-deposit')">üí∞ Deposit</button>
    <button onclick="toggleSidebar('sidebar-transactions')">üìÑ Transactions</button>
    <button onclick="toggleSidebar('sidebar-config')">‚öôÔ∏è Income Config</button>
    <button onclick="toggleSidebar('sidebar-teams')">üìÑ Team</button>
    <button onclick="toggleSidebar('sidebar-incomes')">üìÑ Incomes</button>
  </div>



  <div class="backdrop" id="backdrop" onclick="closeAllSidebars()"></div>

  <div id="sidebar-sql" class="sidebar">
    <h2>Execute SQL Query</h2>
    <p class="sql-description">Lorem Ipsum</p>
    <textarea id="sqlInput" rows="5" placeholder="Enter SQL (e.g., SELECT * FROM users)"></textarea>
    <button class="execute-btn" onclick="runQuery()">Execute</button>

    <div id="error"></div>
    <div id="result"></div>
  </div>

  <!-- Info Sidebar -->
  <div id="sidebar-info" class="sidebar info">
      <h2>Common Database Queries</h2>
      <div id="query-container"></div>
  </div>

  <!-- Register Sidebar -->
  <div id="sidebar-register" class="sidebar register">
    <h2>Register New User</h2>
    <form id="registerForm" class="formcontrol">
      <label>Username:</label>
      <input type="text" id="username" name="username" required>

      <label>Referrer:</label>
      <select name="referral_code" id="referralSelect" required>
        <option value="" disabled selected>-- Select Referrer --</option>
      </select>

      <label>Referral Code:</label>
      <input type="text" name="referral_code" disabled>

      <button type="submit">Register</button>
    </form>
    <div id="registerStatus" style="margin-top: 10px; padding: 8px; display: none;"></div>
  </div>


  <!-- Deposit Sidebar -->
  <div id="sidebar-deposit" class="sidebar deposit">
    <h2>Register New User</h2>
    <form id="depositForm">
      <label>Username:</label>
      <select name="userId" id="userSelect" required>
        <option value="" disabled selected>-- Select User --</option>
      </select>

      <label>Amount:</label>
      <input type="number" id="amount" required />

      <label>Transaction Type:</label>
      <select id="transactionType" required>
        <option value="DEPOSIT">DEPOSIT</option>
        <option value="WITHDRAWAL">WITHDRAWAL</option>
      </select>

      <label>Remarks:</label>
      <input type="text" id="remarks" value="Deposit By Admin"/>

      <button type="submit">Submit</button>
    </form>
    <div class="status" id="depositStatus" style="margin-top: 10px; padding: 8px; display: none;"></div>
  </div>

  <!-- Transactions Sidebar -->
  <div id="sidebar-transactions" class="sidebar transactions">
    <h2>Transactions</h2>
    <table id="transactionsTable" border="1" cellpadding="8" cellspacing="0">
      <thead>
      <tr>
        <th>ID</th>
        <th>Amount</th>
        <th>Balance</th>
        <th>Remarks</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Config Sidebar -->
  <div id="sidebar-config" class="sidebar config">
    <h2>Team Income Configs</h2>
    <!--<table id="teamIncomeConfig" border="1" cellpadding="8" cellspacing="0">
      <thead>
      <tr>
        <th>ID</th>
        <th>Upline Level</th>
        <th>Downline Tier</th>
        <th>Percentage</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>-->

    <table id="pivotTable" border="1" cellpadding="8" cellspacing="0">
      <thead></thead>
      <tbody></tbody>
    </table>

    <hr/>

  </div>



  <!-- Team Sidebar -->
  <div id="sidebar-teams" class="sidebar teams">
    <h2>Teams</h2>

  </div>

  <!-- Income Sidebar -->
  <div id="sidebar-incomes" class="sidebar incomes">
    <h2>Incomes</h2>

  </div>


  <div class="canvas">
      <div class="tree-wrapper" id="treeWrapper">
          <div class="tree" id="mlmTree"></div>
      </div>
  </div>

  <script src="queries.js"></script>
  <script>
      let allUsers = [];
      let selectedUserId = null;
      function loadQueries() {
        const container = document.getElementById("query-container");
        container.innerHTML = "";

        queryData.forEach(item => {
          const block = document.createElement("div");

          block.innerHTML = `
            <h4>${item.title}</h4>
            <div class="copy-section" data-title="${item.title.replace(/"/g, '&quot;')}">
              <pre class="copy-text">${item.query}</pre>
              <img src="clipboard.png" alt="Copy" class="copy-icon" onclick="copyToClipboard(this)" title="Copy to Clipboard" />
              <button class="exec-btn" onclick="executeFromBlock(this)">‚ñ∂Ô∏è Execute</button>
              <div class="copy-status" style="color: green; margin-top: 10px; display: none;">Copied text</div>
            </div>
          `;

          container.appendChild(block);
        });
      }

      // Load queries on page load
      window.addEventListener("DOMContentLoaded", loadQueries);


        function buildTree(node, level = 0) {
          let html = `<li><div class="node" data-level="${level}" onclick="showUserInfo('${node.userId}', '${node.username}', '${node.walletBalance}', event)">${node.username}</div>`;
          if (node.children && node.children.length > 0) {
            html += `<ul>`;
            node.children.forEach(child => {
              html += buildTree(child, level + 1); // Pass incremented level
            });
            html += `</ul>`;
          }
          html += `</li>`;
          return html;
        }

        async function loadTree() {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id') || 1;
            const maxLevel = urlParams.get('level') || 3;
            const response = await fetch(`/api/v1/users/downline-tree/${userId}?maxLevel=${maxLevel}`);
            const treeData = await response.json();
            console.log("TREE_DATA: ", treeData);
            document.getElementById('mlmTree').innerHTML = `<ul>${buildTree(treeData)}</ul>`;
          } catch (error) {
            console.error('Failed to load tree data:', error);
            document.getElementById('mlmTree').innerText = 'Failed to load tree.';
          }
        }

        loadTree();

        function loadUsers() {
          const referralSelect = document.getElementById('referralSelect');
          const userSelect = document.getElementById('userSelect');

          // Reset dropdowns
          referralSelect.innerHTML = '<option value="">-- Select Referrer --</option>';
          userSelect.innerHTML = '<option value="">-- Select User --</option>';

          // Simulated user fetch (replace with actual fetch from backend if needed)
          /*const users = [
            { username: "alice", referral_code: "R001" },
            { username: "bob", referral_code: "R002" },
            { username: "carol", referral_code: "R003" }
          ];*/


          fetch("/api/v1/users")
            .then(response => response.json())
            .then(data => {
              console.log("USERS: ", data);
              const users = data;
              allUsers = users;

              users.forEach(user => {
                // Add to referralSelect: value = referralCode, text = username
                const referralOption  = document.createElement("option");
                referralOption.text = user.username;
                referralOption.value = user.referralCode;
                referralSelect.add(referralOption);


                // Add to userSelect: value = id, text = username
                const userOption = document.createElement("option");
                userOption.value = user.id;
                userOption.text = user.username;
                if (user.id == selectedUserId) {
                  userOption.selected = true;
                }
                userSelect.add(userOption);
              });
          })
          .catch(error => console.error('Error:', error));
        }


        function loadTransaction() {
          const baseUrl = '/api/v1/transactions';
          const url = (selectedUserId && selectedUserId !== 1) ? `${baseUrl}/${selectedUserId}` : baseUrl;

          fetch(url)
            .then(response => response.json())
            .then(data => {
              console.log("TRANSACTIONS: ", data);
                const tbody = document.querySelector('#transactionsTable tbody');
                tbody.innerHTML = ''; // Clear previous rows

                data.content.forEach(txn => {
                  const tr = document.createElement('tr');

                  tr.innerHTML = `
                    <td>${txn.id}</td>
                    <td style="color: ${txn.amount >= 0 ? 'green' : 'red'};">${txn.amount.toFixed(2)}</td>
                    <td>${txn.balance.toFixed(2)}</td>
                    <td>${txn.remarks}</td>
                  `;

                  tbody.appendChild(tr);
                });
          })
          .catch(error => console.error('Error:', error));
      }

      function loadIncomeConfigs() {
        /*fetch("/api/v1/configs/income/team")
          .then(res => res.json())
          .then(data => {
            const tbody = document.querySelector("#teamIncomeConfig tbody");
            tbody.innerHTML = ""; // Clear existing rows

            data.forEach(config => {
              const row = document.createElement("tr");

              row.innerHTML = `
                <td>${config.id}</td>
                <td>${config.uplineLevel}</td>
                <td>${config.downlineTier}</td>
                <td>${(config.percentage * 100).toFixed(2)}%</td>
              `;

              tbody.appendChild(row);
            });
          })
          .catch(error => {
            console.error("Error fetching config:", error);
          });*/
      }

      function loadPivotedConfig() {
        fetch("/api/v1/configs/income/team")
          .then(res => res.json())
          .then(data => {
            const tiers = new Set();
            const levels = new Set();

            // Organize data in map[tier][level] = percentage
            const map = {};
            data.forEach(item => {
              tiers.add(item.downlineTier);
              levels.add(item.uplineLevel);
              if (!map[item.downlineTier]) map[item.downlineTier] = {};
              map[item.downlineTier][item.uplineLevel] = (item.percentage * 100).toFixed(0) + "%";
            });

            const sortedLevels = Array.from(levels).sort(); // Ensure consistent column order
            const sortedTiers = Array.from(tiers).sort();

            // Build header
            const thead = document.querySelector("#pivotTable thead");
            thead.innerHTML = `<tr><th>Level</th>${sortedLevels.map(l => `<th>${l}</th>`).join("")}</tr>`;

            // Build rows
            const tbody = document.querySelector("#pivotTable tbody");
            tbody.innerHTML = "";

            sortedTiers.forEach(tier => {
              const row = document.createElement("tr");
              const cells = sortedLevels.map(level => map[tier][level] || "0%");
              row.innerHTML = `<td>${tier}</td>${cells.map(p => `<td>${p}</td>`).join("")}`;
              tbody.appendChild(row);
            });
          })
          .catch(error => {
            console.error("Error loading pivoted config:", error);
          });
      }



        // Zoom
        let scale = 1;
        const treeWrapper = document.getElementById('treeWrapper');

        function zoomIn() {
          scale += 0.1;
          treeWrapper.style.transform = `scale(${scale})`;
        }

        function zoomOut() {
          scale = Math.max(0.2, scale - 0.1);
          treeWrapper.style.transform = `scale(${scale})`;
        }

        function resetZoom() {
          scale = 1;
          treeWrapper.style.transform = `scale(1)`;
        }

        function addUsers() {
          fetch("/api/v1/users/add-users")
            .then(response => response.json())
            .then(data => {
              console.log("reloading.....");
              //location.reload();
              loadTree();
            })
            .catch(error => console.error('Error:', error));
        }

        /*function showUserInfo(userId, username, walletBalance, event) {
          const label = document.getElementById('userLabel');
          label.textContent = `Selected User: ${username} (ID: ${userId})`;

           // Remove 'selected' class from any previously selected node
          document.querySelectorAll('.node.selected').forEach(node => {
            node.classList.remove('selected');
          });

          // Highlight the clicked node
          const clickedNode = event.currentTarget;
          clickedNode.classList.add('selected');
        }*/


        let selectedNodeElement = null;
        function showUserInfo(userId, username, walletBalance, event) {
          selectedUserId = userId;
          clearHighlights(true);
          console.log("SELECTED_USER_ID: ", selectedUserId);

          // Remove previous selection
          if (selectedNodeElement) {
            selectedNodeElement.classList.remove("selected");
          }

          // Mark current node as selected
          selectedNodeElement = event.target;
          selectedNodeElement.classList.add("selected");

          // Show label (you can customize where to show)
          const label = document.getElementById('selectedUserLabel').textContent = `Selected User: ${username} (ID: ${userId}) ‚ÑπÔ∏è Balance: ${walletBalance}`;
        }


        // Sidebar
        /*function toggleSidebar(type) {
          const sidebarSql = document.getElementById('sidebar-sql');
          const sidebarInfo = document.getElementById('sidebar-info');
          const sidebarRegister = document.getElementById('sidebar-register');
          const backdrop = document.getElementById('backdrop');

          if (type === 'sql') {
            sidebarSql.classList.toggle('open');
          } else if (type === 'info') {
            sidebarInfo.classList.toggle('open');
          } else if (type === 'register') {
            loadUsers();
            sidebarRegister.classList.toggle('open');
          }

          // Show backdrop if either sidebar is open
          if (sidebarSql.classList.contains('open') || sidebarInfo.classList.contains('open') || sidebarInfo.classList.contains('open') || sidebarRegister.classList.contains('open')) {
            backdrop.classList.add('active');
          } else {
            backdrop.classList.remove('active');
          }
        }*/

        function toggleSidebar(id) {
          // Close all sidebars by removing 'open' class
          document.querySelectorAll('.sidebar').forEach(s => s.classList.remove('open'));

          // Show the target sidebar
          const target = document.getElementById(id);
          if (target) {
            target.classList.add('open');

            // Show backdrop
            document.getElementById('backdrop').classList.add('active');

            // Load referral users if opening register sidebar
            if (id === 'sidebar-register' || id === 'sidebar-deposit') {
              loadUsers();
            }

            // Load transactions if opening transactions sidebar
            if (id === 'sidebar-transactions') {
              loadTransaction();
            }
            if (id === 'sidebar-config') {
              loadIncomeConfigs();
              loadPivotedConfig();
            }
          }
        }

        function closeAllSidebars() {
          document.getElementById('sidebar-sql').classList.remove('open');
          document.getElementById('sidebar-info').classList.remove('open');
          document.getElementById('sidebar-register').classList.remove('open');
          document.getElementById('sidebar-deposit').classList.remove('open');
          document.getElementById('sidebar-transactions').classList.remove('open');
          document.getElementById('sidebar-config').classList.remove('open');
          document.getElementById('sidebar-teams').classList.remove('open');
          document.getElementById('sidebar-incomes').classList.remove('open');
          document.getElementById('backdrop').classList.remove('active');
        }

        function copyToClipboard(icon) {
          // Find the related copy-section container
          const copySection = icon.closest('.copy-section');
          const textElem = copySection.querySelector('.copy-text');
          const statusElem = copySection.querySelector('.copy-status');

          const text = textElem.innerText;

          navigator.clipboard.writeText(text).then(() => {
            statusElem.textContent = 'Copied text';
            statusElem.style.color = 'green';
            statusElem.style.display = 'block';

            setTimeout(() => {
              statusElem.style.display = 'none';
            }, 2000);
          }).catch(() => {
            statusElem.textContent = 'Failed to copy';
            statusElem.style.color = 'red';
            statusElem.style.display = 'block';

            setTimeout(() => {
              statusElem.style.display = 'none';
            }, 2000);
          });
        }

        // Execute button (demo logic)
        async function runQuery() {
          const query = document.getElementById('sqlInput').value;
          const resultDiv = document.getElementById("result");
          const errorDiv = document.getElementById("error");
          resultDiv.innerHTML = "";
          errorDiv.textContent = "";

          try {
            const response = await fetch("/api/sql/execute", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || "Query execution failed");
            }

            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
              resultDiv.innerHTML = "<p>No results found.</p>";
              return;
            }

            const table = document.createElement("table");
            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");

            Object.keys(data[0]).forEach((key) => {
              const th = document.createElement("th");
              th.textContent = key;
              headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            data.forEach((row) => {
              const tr = document.createElement("tr");
              Object.values(row).forEach((value) => {
                const td = document.createElement("td");
                td.textContent = value !== null ? value : "";
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            resultDiv.appendChild(table);
          } catch (err) {
            errorDiv.textContent = err.message;
          }
        }
        const sqlInput = document.getElementById("sqlInput");
        sqlInput.addEventListener("keydown", function (e) {
          if (e.ctrlKey && e.key === "Enter") {
            e.preventDefault();
            runQuery();
          }
        });

        function highlightLevel(relativeLevel) {
          if (!selectedNodeElement) {
            alert("Please select a user first.");
            return;
          }

          clearHighlights(true);

          const baseLevel = parseInt(selectedNodeElement.dataset.level);
          const targetLevel = baseLevel + relativeLevel;

          // Select LI node (tree structure)
          const selectedLI = selectedNodeElement.closest("li");

          // Search inside selected subtree only
          const descendants = selectedLI.querySelectorAll(".node");

          // Highlight target nodes
          descendants.forEach(node => {
            const nodeLevel = parseInt(node.dataset.level);
            if (nodeLevel === targetLevel) {
              node.classList.add("level-highlight");
            }
          });

          // Highlight the clicked button
          document.querySelectorAll(".controls-highlight button").forEach(btn => {
            btn.classList.remove("selected");

            if (btn.dataset.level === String(relativeLevel)) {
              btn.classList.add("selected");
            }
          });
        }

        function clearHighlights(removeButtonHighlight = true) {
          // Remove node highlights
          document.querySelectorAll('.node.level-highlight').forEach(el => {
            el.classList.remove('level-highlight');
          });

          // Optionally remove highlight button styles
          if (removeButtonHighlight) {
            document.querySelectorAll('.controls-highlight button').forEach(btn => {
              btn.classList.remove('selected');
            });
          }
        }

    function executeFromBlock(button) {
      const copySection = button.closest('.copy-section');
      const query = copySection.querySelector('.copy-text')?.textContent.trim();
      const title = copySection.dataset.title || "Executing SQL Query";

      // Paste into SQL input and run the query
      document.getElementById('sqlInput').value = query;
      runQuery();

      // Set description
      document.querySelector('.sql-description').textContent = title;

      //toggleSidebar('sql');
      //toggleSidebar('info');

      toggleSidebar('sidebar-info');
      toggleSidebar('sidebar-sql');
      //toggleSidebar('sidebar-register');
    }

    /*function showRegistrationStatusMessage(text, isSuccess) {
      const registerStatusDiv = document.getElementById('registerStatus');
      registerStatusDiv.textContent = text;
      registerStatusDiv.style.display = 'block';

      if (isSuccess) {
        registerStatusDiv.classList.add('success');
        registerStatusDiv.classList.remove('error');
      } else {
        registerStatusDiv.classList.add('error');
        registerStatusDiv.classList.remove('success');
      }
    }*/

    function showStatusMessage(elementId, text, isSuccess) {
      const statusDiv = document.getElementById(elementId);
      if (!statusDiv) return;

      statusDiv.textContent = text;
      statusDiv.style.display = 'block';
      statusDiv.classList.toggle('success', isSuccess);
      statusDiv.classList.toggle('error', !isSuccess);
    }

    document.getElementById('registerForm').addEventListener('submit', function(e) {
      e.preventDefault();

       const username = document.getElementById("username").value;
       const referralCode = document.getElementById("referralSelect").value;

      fetch("/api/v1/users/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            username: username,
            referralCode: referralCode
          })
        })
        .then(async response => {
          const data = await response.json();
          if (!response.ok) throw new Error(data.message || "Registration failed");
          return data;
        })
        .then(data => {
            //alert("Registration successful");
            console.log(data); // Optional: show success data
            //showRegistrationStatusMessage("Registration successful!", true);
            showStatusMessage("registerStatus", "Registration successful!", true);
            loadTree();
        })
        .catch(error => {
          //showRegistrationStatusMessage(error.message, false);
          showStatusMessage("registerStatus", error.message, false);
          console.log("Error: ", error);
        });
    });


    document.getElementById('depositForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const body = {
        userId: document.getElementById('userSelect').value,
        amount: parseFloat(document.getElementById('amount').value),
        transactionType: document.getElementById('transactionType').value,
        remarks: document.getElementById('remarks').value
      };

      fetch("/api/v1/users/deposit", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        })
        .then(async response => {
          const data = await response.json();
          if (!response.ok) throw new Error(data.message || "Registration failed");
          return data;
        })
        .then(data => {
            //alert("Registration successful");
            console.log(data); // Optional: show success data
            showStatusMessage("depositStatus", "Deposit successful!", true);
        })
        .catch(error => {
          showStatusMessage("depositStatus", error.message, false);
          console.log("Error: ", error);
        });
    });

    async function scheduleIncome() {
      try {
        const response = await fetch('/api/v1/bonus/referral/schedule');
        const responseData = await response.json();
        console.log("RESPONSE: ", responseData);
        alert(JSON.stringify(responseData));
      } catch (error) {
        console.error("Error scheduling income:", error);
        alert("Failed to schedule income.");
      }
    }

  </script>

</body>

</html>