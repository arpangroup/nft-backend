<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dynamic MLM Tree</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    .controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }

    .controls button {
      margin-right: 5px;
      padding: 6px 12px;
      font-size: 14px;
    }

    .controls button.selected {
      background-color: #2196f3;
      color: white;
      font-weight: bold;
    }

    .controls-highlight {
      position: fixed;
      top: 50px;
      left: 0px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .controls-highlight button {
      padding: 6px 12px;
      font-size: 14px;
    }

    .controls-highlight button.selected {
      background-color: #444;
      color: white;
      font-weight: bold;
    }

    .sidebar-toggle {
      position: fixed;
      top: 10px;
      right: 0px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-toggle button {
      padding: 6px 12px;
      font-size: 14px;
    }

    .canvas {
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background: #f5f5f5;
    }

    .tree-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      transform-origin: top center;
      transition: transform 0.3s ease;
      padding: 50px 0;
      min-width: 1200px;
    }

    .tree ul {
      position: relative;
      padding-top: 20px;
      display: table;
      margin: 0 auto;
    }

    .tree li {
      display: table-cell;
      text-align: center;
      position: relative;
      padding: 20px 5px 0 5px;
      vertical-align: top;
    }

    .tree li::before,
    .tree li::after {
      content: '';
      position: absolute;
      top: 0;
      width: 50%;
      height: 20px;
      border-top: 2px solid #333;
    }

    .tree li::before {
      left: 0;
      border-right: 2px solid #333;
    }

    .tree li::after {
      right: 0;
      border-left: 2px solid #333;
    }

    .tree li:only-child::before,
    .tree li:only-child::after {
      content: none;
    }

    .tree li:only-child {
      padding-top: 0;
    }

    .tree ul::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      border-left: 2px solid #333;
      height: 20px;
    }

    .node {
      display: inline-block;
      padding: 6px 12px;
      background: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      position: relative;
      z-index: 1;
    }

    .node.selected {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      border-color: #d17d00;
    }

    .node.level-highlight {
      background-color: #2196f3;
      color: white;
      border-color: #1976d2;
    }

    /* Common Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -900px;
      width: 800px;
      height: 100%;
      background: #ffffff;
      border-left: 1px solid #ccc;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
      transition: right 0.3s ease;
      z-index: 1002;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar.open {
      right: 0;
    }

    #query-container{
      padding-bottom: 30px;
    }

    /* Backdrop */
    .backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1001;
      display: none;
    }

    .backdrop.active {
      display: block;
    }

    /* SQL Panel Content */
    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
    }

    button.execute-btn {
      display: block;
      margin-bottom: 15px;
      padding: 8px 16px;
    }

    #error {
      color: red;
      margin-top: 10px;
    }

    #result {
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }

    /* Info Sidebar */
    .sidebar.info {
      background-color: #fdfdfd;
      z-index: 1003;
    }

    /* Copy Section */
    .copy-section {
      position: relative;
      margin-top: 20px;
    }

    .copy-section pre {
      background-color: #eee;
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
      position: relative;
    }

    .copy-icon {
      width: 20px;
      height: 20px;
      position: absolute;
      top: 12px;
      right: 12px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .exec-btn {
      background-color: #e0e0e0;
      border: none;
      padding: 4px 8px;
      margin-left: 5px;
      cursor: pointer;
      font-size: 0.9em;
      border-radius: 4px;
    }

    .exec-btn:hover {
      background-color: #ccc;
    }

    .copy-icon:hover {
      opacity: 1;
    }

    .copy-status {
      color: green;
      margin-top: 10px;
      display: none;
      font-size: 14px;
    }

    #registerForm {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    #registerForm label {
      font-weight: 600;
      margin-bottom: 4px;
    }

    #registerForm input,
    #registerForm select {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    #registerForm button[type="submit"] {
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #registerForm button[type="submit"]:hover {
      background-color: #0056b3;
    }

    #registerStatus {
      margin-top: 10px;
      font-size: 14px;
    }

    .success {
      background-color: #d4edda;  /* light green */
      color: #155724;             /* dark green text */
      border: 1px solid #c3e6cb;
      border-radius: 4px;
    }

    .error {
      background-color: #f8d7da;  /* light red */
      color: #721c24;             /* dark red text */
      border: 1px solid #f5c6cb;
      border-radius: 4px;
    }
  </style>
</head>

<body>

  <div class="controls">
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
    <button onclick="resetZoom()">Reset</button>
    <button onclick="addUsers()">Add Dummy USers</button>
    <div id="selectedUserLabel"
      style="position: fixed; bottom: 10px; left: 10px; background: #222; color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 14px;">
      Click a user to see info here.
    </div>
  </div>

  <div class="controls-highlight">
    <!--    <button onclick="highlightLevel(1)">‚ò∞ Level-A</button>-->
    <button data-level="1" onclick="highlightLevel(1)">Highlight Level-A</button>
    <button data-level="2" onclick="highlightLevel(2)">Highlight Level-B</button>
    <button data-level="3" onclick="highlightLevel(3)">Highlight Level-C</button>
    <button onclick="clearHighlights()">Clear Highlights</button>
  </div>

  <div class="sidebar-toggle">
    <button onclick="toggleSidebar('sidebar-sql')"> ‚ò∞ Execute</button>
    <button onclick="toggleSidebar('sidebar-info')">‚ÑπÔ∏è Show Info</button>
    <button onclick="toggleSidebar('sidebar-register')">üìù Register User</button>
  </div>



  <div class="backdrop" id="backdrop" onclick="closeAllSidebars()"></div>

  <div id="sidebar-sql" class="sidebar">
    <h2>Execute SQL Query</h2>
    <p class="sql-description">Lorem Ipsum</p>
    <textarea id="sqlInput" rows="5" placeholder="Enter SQL (e.g., SELECT * FROM users)"></textarea>
    <button class="execute-btn" onclick="runQuery()">Execute</button>

    <div id="error"></div>
    <div id="result"></div>
  </div>

  <!-- Info Sidebar -->
  <div id="sidebar-info" class="sidebar info">
      <h2>Common Database Queries</h2>
      <div id="query-container"></div>
  </div>

  <!-- Register Sidebar -->
  <div id="sidebar-register" class="sidebar register">
    <h2>Register New User</h2>
    <form id="registerForm">
      <label>Username:</label>
      <input type="text" id="username" name="username" required>

      <label>Referrer:</label>
      <select name="referral_code" id="referralSelect" required>
        <option value="" disabled selected>-- Select Referrer --</option>
      </select>

      <label>Referral Code:</label>
      <input type="text" name="referral_code" disabled>

      <button type="submit">Register</button>
    </form>
    <div id="registerStatus" style="margin-top: 10px; padding: 8px; display: none;"></div>
  </div>

  <div class="canvas">
      <div class="tree-wrapper" id="treeWrapper">
          <div class="tree" id="mlmTree"></div>
      </div>
  </div>

  <script src="queries.js"></script>
  <script>
      function loadQueries() {
        const container = document.getElementById("query-container");
        container.innerHTML = "";

        queryData.forEach(item => {
          const block = document.createElement("div");

          block.innerHTML = `
            <h4>${item.title}</h4>
            <div class="copy-section" data-title="${item.title.replace(/"/g, '&quot;')}">
              <pre class="copy-text">${item.query}</pre>
              <img src="clipboard.png" alt="Copy" class="copy-icon" onclick="copyToClipboard(this)" title="Copy to Clipboard" />
              <button class="exec-btn" onclick="executeFromBlock(this)">‚ñ∂Ô∏è Execute</button>
              <div class="copy-status" style="color: green; margin-top: 10px; display: none;">Copied text</div>
            </div>
          `;

          container.appendChild(block);
        });
      }

      // Load queries on page load
      window.addEventListener("DOMContentLoaded", loadQueries);


        function buildTree(node, level = 0) {
          let html = `<li><div class="node" data-level="${level}" onclick="showUserInfo('${node.userId}', '${node.username}', event)">${node.username}</div>`;
          if (node.children && node.children.length > 0) {
            html += `<ul>`;
            node.children.forEach(child => {
              html += buildTree(child, level + 1); // Pass incremented level
            });
            html += `</ul>`;
          }
          html += `</li>`;
          return html;
        }

        async function loadTree() {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id') || 1;
            const maxLevel = urlParams.get('level') || 3;
            const response = await fetch(`/api/v1/users/downline-tree/${userId}?maxLevel=${maxLevel}`);
            const treeData = await response.json();
            console.log("TREE_DATA: ", treeData);
            document.getElementById('mlmTree').innerHTML = `<ul>${buildTree(treeData)}</ul>`;
          } catch (error) {
            console.error('Failed to load tree data:', error);
            document.getElementById('mlmTree').innerText = 'Failed to load tree.';
          }
        }

        loadTree();

        function loadUsers() {
          const select = document.getElementById('referralSelect');
          select.innerHTML = '<option value="">-- Select Referrer --</option>'; // Reset

          // Simulated user fetch (replace with actual fetch from backend if needed)
          /*const users = [
            { username: "alice", referral_code: "R001" },
            { username: "bob", referral_code: "R002" },
            { username: "carol", referral_code: "R003" }
          ];*/


          fetch("/api/v1/users")
            .then(response => response.json())
            .then(data => {
              console.log("USERS: ", data);
              const users = data;

              users.forEach(user => {
                const option = document.createElement("option");
                option.text = user.username;
                option.value = user.referralCode;
                select.add(option);
              });
          })
          .catch(error => console.error('Error:', error));


        }

        // Zoom
        let scale = 1;
        const treeWrapper = document.getElementById('treeWrapper');

        function zoomIn() {
          scale += 0.1;
          treeWrapper.style.transform = `scale(${scale})`;
        }

        function zoomOut() {
          scale = Math.max(0.2, scale - 0.1);
          treeWrapper.style.transform = `scale(${scale})`;
        }

        function resetZoom() {
          scale = 1;
          treeWrapper.style.transform = `scale(1)`;
        }

        function addUsers() {
          fetch("/api/v1/users/add-users")
            .then(response => response.json())
            .then(data => {
              console.log("reloading.....");
              //location.reload();
              loadTree();
            })
            .catch(error => console.error('Error:', error));
        }

        /*function showUserInfo(userId, username, event) {
          const label = document.getElementById('userLabel');
          label.textContent = `Selected User: ${username} (ID: ${userId})`;

           // Remove 'selected' class from any previously selected node
          document.querySelectorAll('.node.selected').forEach(node => {
            node.classList.remove('selected');
          });

          // Highlight the clicked node
          const clickedNode = event.currentTarget;
          clickedNode.classList.add('selected');
        }*/


        let selectedNodeElement = null;
        let selectedUserId = null;
        function showUserInfo(userId, username, event) {
          selectedUserId = userId;
          clearHighlights(true);

          // Remove previous selection
          if (selectedNodeElement) {
            selectedNodeElement.classList.remove("selected");
          }

          // Mark current node as selected
          selectedNodeElement = event.target;
          selectedNodeElement.classList.add("selected");

          // Show label (you can customize where to show)
          const label = document.getElementById('selectedUserLabel').textContent = `Selected User: ${username} (ID: ${userId})`;
        }


        // Sidebar
        /*function toggleSidebar(type) {
          const sidebarSql = document.getElementById('sidebar-sql');
          const sidebarInfo = document.getElementById('sidebar-info');
          const sidebarRegister = document.getElementById('sidebar-register');
          const backdrop = document.getElementById('backdrop');

          if (type === 'sql') {
            sidebarSql.classList.toggle('open');
          } else if (type === 'info') {
            sidebarInfo.classList.toggle('open');
          } else if (type === 'register') {
            loadUsers();
            sidebarRegister.classList.toggle('open');
          }

          // Show backdrop if either sidebar is open
          if (sidebarSql.classList.contains('open') || sidebarInfo.classList.contains('open') || sidebarInfo.classList.contains('open') || sidebarRegister.classList.contains('open')) {
            backdrop.classList.add('active');
          } else {
            backdrop.classList.remove('active');
          }
        }*/

        function toggleSidebar(id) {
          // Close all sidebars by removing 'open' class
          document.querySelectorAll('.sidebar').forEach(s => s.classList.remove('open'));

          // Show the target sidebar
          const target = document.getElementById(id);
          if (target) {
            target.classList.add('open');

            // Show backdrop
            document.getElementById('backdrop').classList.add('active');

            // Load referral users if opening register sidebar
            if (id === 'sidebar-register') {
              loadUsers();
            }
          }
        }

        function closeAllSidebars() {
          document.getElementById('sidebar-sql').classList.remove('open');
          document.getElementById('sidebar-info').classList.remove('open');
          document.getElementById('sidebar-register').classList.remove('open');
          document.getElementById('backdrop').classList.remove('active');
        }

        function copyToClipboard(icon) {
          // Find the related copy-section container
          const copySection = icon.closest('.copy-section');
          const textElem = copySection.querySelector('.copy-text');
          const statusElem = copySection.querySelector('.copy-status');

          const text = textElem.innerText;

          navigator.clipboard.writeText(text).then(() => {
            statusElem.textContent = 'Copied text';
            statusElem.style.color = 'green';
            statusElem.style.display = 'block';

            setTimeout(() => {
              statusElem.style.display = 'none';
            }, 2000);
          }).catch(() => {
            statusElem.textContent = 'Failed to copy';
            statusElem.style.color = 'red';
            statusElem.style.display = 'block';

            setTimeout(() => {
              statusElem.style.display = 'none';
            }, 2000);
          });
        }

        // Execute button (demo logic)
        async function runQuery() {
          const query = document.getElementById('sqlInput').value;
          const resultDiv = document.getElementById("result");
          const errorDiv = document.getElementById("error");
          resultDiv.innerHTML = "";
          errorDiv.textContent = "";

          try {
            const response = await fetch("/api/sql/execute", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || "Query execution failed");
            }

            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
              resultDiv.innerHTML = "<p>No results found.</p>";
              return;
            }

            const table = document.createElement("table");
            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");

            Object.keys(data[0]).forEach((key) => {
              const th = document.createElement("th");
              th.textContent = key;
              headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            data.forEach((row) => {
              const tr = document.createElement("tr");
              Object.values(row).forEach((value) => {
                const td = document.createElement("td");
                td.textContent = value !== null ? value : "";
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            resultDiv.appendChild(table);
          } catch (err) {
            errorDiv.textContent = err.message;
          }
        }
        const sqlInput = document.getElementById("sqlInput");
        sqlInput.addEventListener("keydown", function (e) {
          if (e.ctrlKey && e.key === "Enter") {
            e.preventDefault();
            runQuery();
          }
        });

        function highlightLevel(relativeLevel) {
          if (!selectedNodeElement) {
            alert("Please select a user first.");
            return;
          }

          clearHighlights(true);

          const baseLevel = parseInt(selectedNodeElement.dataset.level);
          const targetLevel = baseLevel + relativeLevel;

          // Select LI node (tree structure)
          const selectedLI = selectedNodeElement.closest("li");

          // Search inside selected subtree only
          const descendants = selectedLI.querySelectorAll(".node");

          // Highlight target nodes
          descendants.forEach(node => {
            const nodeLevel = parseInt(node.dataset.level);
            if (nodeLevel === targetLevel) {
              node.classList.add("level-highlight");
            }
          });

          // Highlight the clicked button
          document.querySelectorAll(".controls-highlight button").forEach(btn => {
            btn.classList.remove("selected");

            if (btn.dataset.level === String(relativeLevel)) {
              btn.classList.add("selected");
            }
          });
        }

        function clearHighlights(removeButtonHighlight = true) {
          // Remove node highlights
          document.querySelectorAll('.node.level-highlight').forEach(el => {
            el.classList.remove('level-highlight');
          });

          // Optionally remove highlight button styles
          if (removeButtonHighlight) {
            document.querySelectorAll('.controls-highlight button').forEach(btn => {
              btn.classList.remove('selected');
            });
          }
        }

    function executeFromBlock(button) {
      const copySection = button.closest('.copy-section');
      const query = copySection.querySelector('.copy-text')?.textContent.trim();
      const title = copySection.dataset.title || "Executing SQL Query";

      // Paste into SQL input and run the query
      document.getElementById('sqlInput').value = query;
      runQuery();

      // Set description
      document.querySelector('.sql-description').textContent = title;

      //toggleSidebar('sql');
      //toggleSidebar('info');

      toggleSidebar('sidebar-info');
      toggleSidebar('sidebar-sql');
      //toggleSidebar('sidebar-register');
    }

    function showRegistrationStatusMessage(text, isSuccess) {
      const registerStatusDiv = document.getElementById('registerStatus');
      registerStatusDiv.textContent = text;
      registerStatusDiv.style.display = 'block';

      if (isSuccess) {
        registerStatusDiv.classList.add('success');
        registerStatusDiv.classList.remove('error');
      } else {
        registerStatusDiv.classList.add('error');
        registerStatusDiv.classList.remove('success');
      }
    }

    document.getElementById('registerForm').addEventListener('submit', function(e) {
      e.preventDefault();

       const username = document.getElementById("username").value;
       const referralCode = document.getElementById("referralSelect").value;

      fetch("/api/v1/users/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            username: username,
            referralCode: referralCode
          })
        })
        .then(async response => {
          const data = await response.json();
          if (!response.ok) throw new Error(data.message || "Registration failed");
          return data;
        })
        .then(data => {
            //alert("Registration successful");
            console.log(data); // Optional: show success data
            showRegistrationStatusMessage("Registration successful!", true);
            loadTree();
        })
        .catch(error => {
          showRegistrationStatusMessage(error.message, false);
          console.log("Error: ", error);
        });
    });

  </script>

</body>

</html>